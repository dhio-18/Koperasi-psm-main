name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Validate Secrets
        run: |
          echo "Checking required GitHub Secrets..."
          MISSING_SECRETS=()
          [ -z "${{ secrets.SSH_HOST }}" ] && MISSING_SECRETS+=("SSH_HOST")
          [ -z "${{ secrets.SSH_USER }}" ] && MISSING_SECRETS+=("SSH_USER")
          [ -z "${{ secrets.REMOTE_DIR }}" ] && MISSING_SECRETS+=("REMOTE_DIR")
          [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ] && MISSING_SECRETS+=("SSH_PRIVATE_KEY")
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "❌ Missing required secrets:"
            for secret in "${MISSING_SECRETS[@]}"; do
              echo "  - $secret"
            done
            exit 1
          fi
          echo "✓ All required secrets are configured"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mysql, curl, gd, intl, iconv, mbstring, bcmath
          tools: composer:v2
          coverage: none

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install PHP dependencies
        run: composer install --no-dev --prefer-dist --no-interaction --no-progress --optimize-autoloader

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install JavaScript dependencies
        run: npm ci

      - name: Build assets
        run: npm run build

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          cat > ~/.ssh/id_rsa << 'SSHKEY'
          ${{ secrets.SSH_PRIVATE_KEY }}
          SSHKEY
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to server
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
        run: |
          rsync -avz \
            -e "ssh -o StrictHostKeyChecking=accept-new" \
            --exclude='.env' \
            --exclude='.env.local' \
            --exclude='.env.production' \
            --exclude='.env.*.php' \
            --exclude='node_modules' \
            --exclude='vendor' \
            --exclude='storage/app/*' \
            --exclude='storage/logs/*' \
            --exclude='storage/framework/cache/*' \
            --exclude='storage/framework/sessions/*' \
            --exclude='storage/framework/views/*' \
            --exclude='bootstrap/cache/*' \
            --exclude='.git' \
            --exclude='.github' \
            --delete-excluded \
            . ${SSH_USER}@${SSH_HOST}:${REMOTE_DIR}

      - name: Run deployment script on server
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'ENDSSH'
            cd ${{ secrets.REMOTE_DIR }}
            
            # Fix permissions sebelum deployment
            sudo chown -R www-data:www-data storage bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache
            
            # Install dependencies
            composer install --no-dev --optimize-autoloader --no-interaction
            
            # Clear dan rebuild cache
            php artisan config:clear
            php artisan cache:clear
            php artisan view:clear
            php artisan route:clear
            
            # Optimize untuk production
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            # Fix permissions lagi setelah cache rebuild
            sudo chown -R www-data:www-data storage bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache
            
            # Restart services
            sudo systemctl restart php8.2-fpm
            sudo systemctl reload nginx
            
            echo "✓ Deployment completed successfully"
          ENDSSH

      - name: Run health check
        run: |
          sleep 10
          curl -f https://koperasipsm.web.id/ || echo "⚠ Health check failed"
        continue-on-error: true
